---
title: "Gephi inputs"
author: "Eric Bastien"
date: "2022-12-29"
output: html_document
---


Libraries
```{r}
library(tidyverse)
```


Data
```{r}
data <- read_tsv('~/Desktop/erie_story_r_work/10kb_cutoff_sep_bloom_with_ma_phage_093thresh_1_30_23.tsv')
meta <- read_tsv('~/Desktop/erie_story_r_work/2014_story_metadata_updated_12_15_21.tsv') %>%
  mutate('Sample_number' = str_extract(samples, '\\d*$'))

# create new column for meta with just the numbers
```

Filenames to use to save the nodes and edges files. 
```{r}
nodename <- 'add_node_name_here.csv'
edgename <- 'add_edge_name_here.csv'
```



# Nodes

First, the node list need to be created. In this case, a node either represent a unique virus or a unique host. 

```{r}
# retrieve unique names for viruses and hosts, and their type (virus or host)
Name <- c(unique(data$phage), unique(data$host))
Type <- c(rep('Virus', length(unique(data$phage))), rep('Host', length(unique(data$host))))
  
# create ID vector (sequence of numbers of same length as Name)
ID <- seq(length(Name))

# create the nodes dataframe
nodes <- tibble(ID, Name, Type)

# add sample number to nodes
nodes['Sample'] <- str_extract(nodes$Name, '\\d{5}')

```

This is bare minimum needed for the nodes dataframe. The code chunk below adds properties related to the nodes. 

```{r}
# adding station and fraction
nodes['Station'] <- NA
nodes['Fraction'] <- NA
for(i in 1:nrow(nodes)){
  sample <- nodes$Sample[i]
  nodes$Station[i] <- meta$Station[which(meta$Sample_number == sample)]
  nodes$Fraction[i] <- meta$fraction[which(meta$Sample_number == sample)]
}

```





# Edges

Next we need to create the edge list. The edge list encode which nodes are connected together. It needs a source (which will always be
the viruses) and a target (which will always be the host). In addition, it needs the type (undirected = no arrows) and the weight (for now
we will use 1).

The predictions data is already an edge list since it represents predicted interactions. However, instead of using phagename and host name, it 
needs to use the ID numbers from the node list. 
```{r}
# make a copy of edges
edges <- data

# parameters
weight <- 1
type <- 'undirected'

# create new columns in the edges dataframe
edges['Weight'] <- weight
edges['Type'] <- type
edges['Source'] <- NA
edges['Target'] <- NA

# fill the Source and Target columns
for(i in 1:nrow(data)){
  
  # retrieve virus and host name
  virus <- data$phage[i]
  host <- data$host[i]
  
  # retrieve their ID numbers and store them in their respective columns in the edges dataframe
  virusID <- nodes$ID[which(nodes$Name == virus)]
  hostID <- nodes$ID[which(nodes$Name == host)]
  
  # store value
  edges$Source[i] <- virusID
  edges$Target[i] <- hostID

}

```


#now lets add polygon columns to our nodes so we can change their shape in gephi 
```{r}
nodes$polygon <- nodes$Type
nodes$polygon <- gsub("Host", "2", nodes$polygon)
nodes$polygon <- gsub("Virus", "3", nodes$polygon)
```


#and lets add taxonomy as another potential column to distinguish our nodes

```{r}
custom_taxonomy <- read_tsv("~/Desktop/erie_story_r_work/combined_good_contigs_and_vrhyme_n_linked_bins_prodigal_annotations.PTT.virus-taxonomy.tsv")
names(custom_taxonomy)[names(custom_taxonomy) == 'scaffold'] <- "Name"

```

#modify predictions so vrhyme bins can receive taxonomic annotations

```{r}
nodes$Name <- gsub("concatenated_", "", nodes$Name)
```

##merge predictions and taxonomy
```{r}
nodes <- left_join(nodes,custom_taxonomy,by="Name")
```


# Save files

```{r}
write_csv(nodes, file="~/Desktop/erie_story_r_work/10kb_only_sep29_infection_network_nodes_1_30_23.csv")
write_csv(edges, file="~/Desktop/erie_story_r_work/10kb_only_sep29_infection_network_edges_1_30_23.csv")

```



























