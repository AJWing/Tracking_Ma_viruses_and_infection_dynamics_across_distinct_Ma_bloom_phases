---
title: "adjusted_samples_beta_diversity_2014_erie_story"
author: "A.J Wing"
date: "1/14/2022"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary packages
```{r}
library(tidyr)
library(readr)
library(dplyr)
library(ggplot2)
library(viridis)
library(dendextend)
library(gridExtra)
library(vegan)
library(ape)
library(RColorBrewer)
library(jcolors)
library(showtext)
```

# Import commmon files

## import tpm normalized read counts
```{r}
merged_tpm <- read_tsv("~/Desktop/erie_story_r_work/abund_table_tpm_normalized_clusters_with_metadata.tsv")
```

### Beta diversity with modified samples to exclude samples with missing params 

##Create abundance table for diversity analyses
```{r}

abund_table <- merged_tpm[-c((ncol(merged_tpm)-25):ncol(merged_tpm))]

abund_table <- abund_table[-c(15,20,24,29),]
```


## create metadata for diversity analyses--removed rows and columns with multiple NAs
```{r}
metadata <- merged_tpm[,c((ncol(merged_tpm)-25):ncol(merged_tpm))]

metadata <- metadata[-c(15,20,24,29),]

metadata <- metadata[,-c(6,19)]
```


##rename columns to be agreeable for plotting
```{r}

names(metadata)[names(metadata) == 'AquaFluor-PC'] <- "AquaFluor_PC"
names(metadata)[names(metadata) == 'AquaFluor-CHL'] <- "AquaFluor_CHL"
names(metadata)[names(metadata) == '10AU-CHL'] <- "TenAU_CHL"

```


## Use Bray Curtis to calculate distance between samples


```{r}
nmds_res <- vegan::metaMDS(abund_table, distance="bray", try=100)

```


##Perform envfit on continuous variables

```{r}
ef <- vegan::envfit(nmds_res, metadata[,c(5:24)], permu=999, na.rm=T)
ef

```


#order dates
```{r}

metadata$ordered_dates = factor(metadata$Date, levels=c("8-Jul-14","21-Jul-14","29-Jul-14","4-Aug-14","25-Aug-14","8-Sep-14","23-Sep-14","29-Sep-14","6-Oct-14","20-Oct-14","27-Oct-14"))


```


#Plot NMDS with environmental params by station and fraction
```{r}

ss <- as.data.frame(nmds_res$points)

ss$sample <- rownames(ss)
ss$Station <- metadata$Station
ss$Fraction <- metadata$fraction

pal <- ggthemes::tableau_color_pal(palette="Tableau 20", type="regular")

p1 <- ggplot(ss, aes(x=MDS1,y=MDS2)) + 
  geom_point(aes( shape = Station, colour = Fraction, fill = Fraction), alpha=0.5, size=8) +
#  geom_segment(aes(x=0, y=0,
#                 xend=scores(ef, "vectors")[2,1], yend=scores(ef, "vectors")[2,2],
#                 ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
#  geom_text(aes(x=scores(ef, "vectors")[2,1], y=scores(ef, "vectors")[2,2]),
#                label=names(ef$vectors$r)[2], nudge_x=-0.1, nudge_y=0,size=3,
#            check_overlap = T) +
#  geom_segment(aes(x=0, y=0,
#                   xend=scores(ef, "vectors")[3,1], yend=scores(ef, "vectors")[3,2],
#                   ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
#  geom_text(aes(x=scores(ef, "vectors")[3,1], y=scores(ef, "vectors")[3,2]),
#                label=names(ef$vectors$r)[3], nudge_x=-0.1, nudge_y=-0, size=3,
#            check_overlap = T) +
#  geom_segment(aes(x=0, y=0,
#                   xend=scores(ef, "vectors")[7,1], yend=scores(ef, "vectors")[7,2],
#                   ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
#  geom_text(aes(x=scores(ef, "vectors")[7,1], y=scores(ef, "vectors")[7,2]),
#                label=names(ef$vectors$r)[7], nudge_x=-0.1, nudge_y=0, size=3,
#            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[8,1], yend=scores(ef, "vectors")[8,2],
                   ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[8,1], y=scores(ef, "vectors")[8,2]),
                label=names(ef$vectors$r)[8], nudge_x=-0.1, nudge_y=0, size=3,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[19,1], yend=scores(ef, "vectors")[19,2],
                 ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[19,1], y=scores(ef, "vectors")[19,2]),
                label=names(ef$vectors$r)[19], nudge_y=-0.02, nudge_x=0, size=3,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[16,1], yend=scores(ef, "vectors")[16,2],
                 ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[16,1], y=scores(ef, "vectors")[16,2]),
                label=names(ef$vectors$r)[16], nudge_y=0, nudge_x=0.15, size=3,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[17,1], yend=scores(ef, "vectors")[17,2],
                 ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[17,1], y=scores(ef, "vectors")[17,2]),
                label=names(ef$vectors$r)[17], nudge_y=0.05, nudge_x=0.05, size=3,
            check_overlap = T) +
  scale_colour_jcolors(palette = "default") +
   theme(panel.background = element_blank(),
        text = element_text(family = "merriweather"),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        #axis.text=element_blank(),
        #axis.ticks=element_blank(),
        #axis.title=element_text(size=16),
        plot.title = element_text(size = 20, hjust = 0.5, colour = "black"),
        legend.key=element_blank(),
        legend.position="bottom",
        legend.background = element_blank(),
        legend.key.size = unit(.8, "line"),
        legend.text=element_text(size=9),
        legend.title = element_blank()) +
  #ggtitle("Lake Erie Viral Community NMDS Plot--Bray Curtis Dissimilarities") +
  guides(size=FALSE) + xlab("NMDS 1") + ylab("NMDS 2") +
  #scale_shape_manual(name="",
  #                   values = c(13,4,2,10,5,8,0,6,3,12,14,1)) + 
 # scale_color_manual(name="",
 #                    values = alpha(pal(length(unique(ss$study))), 1)) + 
 # scale_fill_manual(name="",
 #                    values = alpha(pal(length(unique(ss$study))), 0.3)) + 
  coord_equal()

p1

```
#Store NMDS ordination as PNG
```{r}
png("~/Desktop/erie_story_r_work/le_viral_comm_beta_div_with_continuous_params_by_fraction.png", width=800, height=800)
p1
dev.off()
```
#Store NMDS as PDF
```{r}
pdf("~/Desktop/erie_story_r_work/le_viral_comm_beta_div_with_continuous_params_by_fraction.pdf", width=8, height=8)
p1
dev.off()
```

#Plot NMDS with environmental params by date and fraction
```{r}

ss <- as.data.frame(nmds_res$points)

ss$sample <- rownames(ss)
ss$date <- metadata$ordered_dates
ss$Fraction <- metadata$fraction

p2 <- ggplot(ss, aes(x=MDS1,y=MDS2)) + 
  geom_point(aes( shape = Fraction, colour = date, fill = date), alpha=0.9, size=8) +
  scale_colour_manual(name = '',
                     values = alpha(c(viridis(8)[8:1]), 1)) +
  scale_fill_manual(name = '',
                     values = alpha(c(viridis(8)[8:1]), 0.2)) +
#  geom_segment(aes(x=0, y=0,
#                 xend=scores(ef, "vectors")[2,1], yend=scores(ef, "vectors")[2,2],
#                 ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
#  geom_text(aes(x=scores(ef, "vectors")[2,1], y=scores(ef, "vectors")[2,2]),
#                label=names(ef$vectors$r)[2], nudge_x=-0.1, nudge_y=0,size=3,
#            check_overlap = T) +
#  geom_segment(aes(x=0, y=0,
#                   xend=scores(ef, "vectors")[3,1], yend=scores(ef, "vectors")[3,2],
#                   ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
#  geom_text(aes(x=scores(ef, "vectors")[3,1], y=scores(ef, "vectors")[3,2]),
#                label=names(ef$vectors$r)[3], nudge_x=-0.1, nudge_y=-0, size=3,
#            check_overlap = T) +
#  geom_segment(aes(x=0, y=0,
#                   xend=scores(ef, "vectors")[7,1], yend=scores(ef, "vectors")[7,2],
#                   ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
#  geom_text(aes(x=scores(ef, "vectors")[7,1], y=scores(ef, "vectors")[7,2]),
#                label=names(ef$vectors$r)[7], nudge_x=-0.1, nudge_y=0, size=3,
#            check_overlap = T) +
   geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[8,1], yend=scores(ef, "vectors")[8,2],
                   ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[8,1], y=scores(ef, "vectors")[8,2]),
                label=names(ef$vectors$r)[8], nudge_x=-0.1, nudge_y=0, size=3,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[19,1], yend=scores(ef, "vectors")[19,2],
                 ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[19,1], y=scores(ef, "vectors")[19,2]),
                label=names(ef$vectors$r)[19], nudge_y=-0.02, nudge_x=0, size=3,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[16,1], yend=scores(ef, "vectors")[16,2],
                 ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[16,1], y=scores(ef, "vectors")[16,2]),
                label=names(ef$vectors$r)[16], nudge_y=0, nudge_x=0.15, size=3,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[17,1], yend=scores(ef, "vectors")[17,2],
                 ), colour="black", arrow=arrow(length = unit(0.03,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[17,1], y=scores(ef, "vectors")[17,2]),
                label=names(ef$vectors$r)[17], nudge_y=0.05, nudge_x=0.05, size=3,
            check_overlap = T) +
  #scale_color_jcolors(palette = "pal8") +
  #scale_fill_jcolors(palette = "pal8") +
   theme(panel.background = element_blank(),
        text = element_text(family = "merriweather"),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        #axis.text=element_blank(),
        #axis.ticks=element_blank(),
        axis.title=element_text(size=16),
        plot.title = element_text(size = 20, hjust = 0.5, colour = "black"),
        legend.key=element_blank(),
        legend.position="bottom",
        legend.background = element_blank(),
        legend.key.size = unit(.8, "line"),
        legend.text=element_text(size=9),
        legend.title = element_blank()) +
  #ggtitle("Lake Erie Viral Community NMDS Plot--Bray Curtis Dissimilarities") +
  guides(size=FALSE) + xlab("NMDS 1") + ylab("NMDS 2") +
  scale_shape_manual(name="",
                     values = c(21,22,23,24,25)) + 
  coord_equal()

p2 

```

#Store NMDS ordination as PNG
```{r}
png("~/Desktop/erie_story_r_work/le_viral_comm_beta_div_with_continuous_params_by_date.png", width=800, height=800)
p2
dev.off()
```
#Store NMDS as PDF
```{r}
pdf("~/Desktop/erie_story_r_work/le_viral_comm_beta_div_with_continuous_params_by_date_sep_22.pdf", width=8, height=8)
p2
dev.off()
```






###Let's try surface plots of interesting environmental variables with our sample counts

```{r}

vec <- envfit(nmds_res, metadata$AquaFluor_PC, permu=999)
vec

ef <- envfit(nmds_res~metadata$AquaFluor_PC)
plot(nmds_res, display = "sites", main= "Fitted Vector", type = "t")
surfin <- ordisurf(nmds_res, metadata$AquaFluor_PC, add=TRUE, method="ML")

extract.xyz <- function(obj) {
xy <- expand.grid( x=obj$grid$x, y=obj$grid$y)
xyz <- cbind(xy, c(obj$grid$z))
names(xyz) <- c("MDS1", "MDS2", "z")
return(xyz)
}

surfin_df <- extract.xyz(obj=surfin)



ss <- as.data.frame(nmds_res$points)
ss$site <- rownames(ss)
ss$station <- metadata$Station
ss$fraction <- metadata$fraction
ss$pc <- metadata$AquaFluor_PC
ss$z <- NA

p1 <- ggplot(data = surfin_df, aes(x=MDS1,y=MDS2, z=z)) + stat_contour(aes()) + 
  geom_point(data = ss, aes( x=MDS1, y=MDS2, shape = station, colour = fraction, fill = fraction), alpha=0.5, size=6) +
  scale_colour_jcolors(palette = "default") +
   theme(panel.background = element_blank(),
        text = element_text(family = "merriweather"),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        #axis.text=element_blank(),
        #axis.ticks=element_blank(),
        axis.title=element_text(size=16),
        plot.title = element_text(size = 14, hjust = 0.5, colour = "black"),
        legend.key=element_blank(),
        legend.position="bottom",
        legend.background = element_blank(),
        legend.key.size = unit(.8, "line"),
        legend.text=element_text(size=9),
        legend.title = element_blank()) +
  ggtitle("Lake Erie Viral Community NMDS Plot--Bray Curtis Dissimilarities") +
  guides(size=FALSE) + xlab("NMDS 1") + ylab("NMDS 2") +
  #scale_shape_manual(name="",
  #                   values = c(13,4,2,10,5,8,0,6,3,12,14,1)) + 
 # scale_color_manual(name="",
 #                    values = alpha(pal(length(unique(ss$study))), 1)) + 
 # scale_fill_manual(name="",
 #                    values = alpha(pal(length(unique(ss$study))), 0.3)) + 
  coord_equal()

p1

```


```{r}
dist_abund <- vegan::vegdist(abund_table, method="bray")
```

#Perform adonis on nmds adjusted samples
```{r}
adonis <- vegan::adonis(dist_abund ~ Date+fraction+Station, data=metadata, 
                 permutations = 9999)
adonis



```



#Perform adonis on adjusted environmental params

##Individual parameters
```{r}
adonis <- vegan::adonis(dist_abund ~ Par, data=metadata, strata = metadata$fraction, 
                 permutations = 9999)

adonis
#                        p-value           r2
#Station_Depth           0.1767             0.03263
#Temp                    0.0015             0.04571
#Cond                    0.0915             0.03791
#SpCond                  0.2961             0.03107
#BeamAtten               0.6547             0.03008
#Transmiss               0.213              0.03233
#DO                      0.017              0.03875
#Par                     1e-04              0.04229
#TenAU_CHL               2e-04              0.04623
#AquaFluor_PC            1e-04              0.0464
#AquaFluor_CHL           0.0168             0.03889
#Turbidity               0.0037             0.04046
#Particulate_Microcystin 0.039              0.03678
#PC                      0.0585             0.03483
#CHLa                    0.2765             0.03293
#Nitrate                 4e-04              0.04121
#Ammonia                 0.0246             0.03481
#SRP                     0.137              0.03797
#TP                      3e-04              0.04319
#TDP                     0.1713             0.03884


```


##Combined parameters
```{r}

adonis <- vegan::adonis(dist_abund ~ Nitrate+Temp+TP+Par+DO+AquaFluor_PC+Particulate_Microcystin+Ammonia+fraction, data=metadata, strata = metadata$Date, by="margin",  
                 permutations = 9999)

adonis

```

##Water Chemistry Parameters
```{r}

adonis <- vegan::adonis(dist_abund ~ Par+Temp+TP+Nitrate+DO+Turbidity+Ammonia+Date, data=metadata, strata = metadata$fraction, 
                 permutations = 9999)

adonis

```


##Bloom Parameters
```{r}

adonis <- vegan::adonis(dist_abund ~ AquaFluor_PC+AquaFluor_CHL+Particulate_Microcystin+Date, data=metadata, strata = metadata$fraction, 
                 permutations = 9999)

adonis

```

#Perform PCOA on adjusted samples

```{r}
PCOA <- pcoa(dist_abund)
#CCA <- cca(abund_table_hel)
```


#Plot PCOA with different axes

```{r}
ss <- tibble(Axis.1 = PCOA$vectors[,1],
             Axis.2 = PCOA$vectors[,2],
             Axis.3 = PCOA$vectors[,3],
             sample = metadata$samples,
             fraction = metadata$fraction,
             station = metadata$Station)
             

p1 <- ggplot(ss, aes(x=Axis.1, y=Axis.2)) + 
  geom_point(aes(colour = fraction, fill = fraction, shape = station), alpha = 1, size = 3) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[2,1], yend=scores(ef, "vectors")[2,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[2,1], y=scores(ef, "vectors")[2,2]),
                label=names(ef$vectors$r)[2], nudge_x=0, nudge_y=0,size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[3,1], yend=scores(ef, "vectors")[3,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[3,1], y=scores(ef, "vectors")[3,2]),
                label=names(ef$vectors$r)[3], nudge_x=-0, nudge_y=-0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[7,1], yend=scores(ef, "vectors")[7,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[7,1], y=scores(ef, "vectors")[7,2]),
                label=names(ef$vectors$r)[7], nudge_y=0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[8,1], yend=scores(ef, "vectors")[8,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[8,1], y=scores(ef, "vectors")[8,2]),
                label=names(ef$vectors$r)[8], nudge_y=0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[13,1], yend=scores(ef, "vectors")[13,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[13,1], y=scores(ef, "vectors")[13,2]),
                label=names(ef$vectors$r)[13], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[16,1], yend=scores(ef, "vectors")[16,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[16,1], y=scores(ef, "vectors")[16,2]),
                label=names(ef$vectors$r)[16], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[17,1], yend=scores(ef, "vectors")[17,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[17,1], y=scores(ef, "vectors")[17,2]),
                label=names(ef$vectors$r)[17], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
  scale_colour_jcolors(palette = "default") +
   theme(panel.background = element_blank(),
        text = element_text(family = "merriweather"), 
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.title=element_text(size=12),
        legend.key=element_blank(),
        legend.position="bottom",
        legend.background = element_blank(),
        legend.key.size = unit(.8, "line"),
        legend.text=element_text(size=8),
        legend.title = element_blank()) +
  guides(size="none") + xlab("Axis 1 (9.3%)") + ylab("Axis 2 (6.3%)") +

  coord_equal()

p1


ss <- tibble(Axis.1 = PCOA$vectors[,1],
             Axis.2 = PCOA$vectors[,2],
             Axis.3 = PCOA$vectors[,3],
             sample = metadata$samples,
             fraction = metadata$fraction,
             date = metadata$Date)

p2 <- ggplot(ss, aes(x=Axis.1, y=Axis.3)) + 
  geom_point(aes(colour = date, fill = date, shape = fraction), alpha = 1, size = 3) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[2,1], yend=scores(ef, "vectors")[2,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[2,1], y=scores(ef, "vectors")[2,2]),
                label=names(ef$vectors$r)[2], nudge_x=0, nudge_y=0,size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[3,1], yend=scores(ef, "vectors")[3,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[3,1], y=scores(ef, "vectors")[3,2]),
                label=names(ef$vectors$r)[3], nudge_x=-0, nudge_y=-0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[7,1], yend=scores(ef, "vectors")[7,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[7,1], y=scores(ef, "vectors")[7,2]),
                label=names(ef$vectors$r)[7], nudge_y=0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[8,1], yend=scores(ef, "vectors")[8,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[8,1], y=scores(ef, "vectors")[8,2]),
                label=names(ef$vectors$r)[8], nudge_y=0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[13,1], yend=scores(ef, "vectors")[13,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[13,1], y=scores(ef, "vectors")[13,2]),
                label=names(ef$vectors$r)[13], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[16,1], yend=scores(ef, "vectors")[16,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[16,1], y=scores(ef, "vectors")[16,2]),
                label=names(ef$vectors$r)[16], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[17,1], yend=scores(ef, "vectors")[17,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[17,1], y=scores(ef, "vectors")[17,2]),
                label=names(ef$vectors$r)[17], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
  scale_color_jcolors(palette = "pal8") +
  scale_fill_jcolors(palette = "pal8") +
   theme(panel.background = element_blank(),
        text = element_text(family = "merriweather"), 
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.title=element_text(size=12),
        legend.key=element_blank(),
        legend.position="bottom",
        legend.background = element_blank(),
        legend.key.size = unit(.8, "line"),
        legend.text=element_text(size=8),
        legend.title = element_blank()) +
  guides(size="none") + xlab("Axis 1 (9.3%)") + ylab("Axis 3 (5.2%)") +

  scale_shape_manual(name="", values = c(21,22,23,24,25)) +
  
  coord_equal()

p2


```



#Store PCOA plot as PNG
```{r}
png("fig_3_log.png", width=3.2, height=3.2, units="in", res=300)

p1

dev.off() 
```


#Look at percent variation explained for all variables 
```{r}
barplot(PCOA$values$Relative_eig)
PCOA$values$Relative_eig[c(1,2)]
```



#Perform CCA on adjusted samples

##capscale 
##multiple environmental params
```{r}
vare.cap <- capscale(dist_abund ~ Nitrate+Temp+Par+Turbidity+DO+Cond+Par+Particulate_Microcystin+Ammonia, 
                     metadata)
```


##just trying to look at fraction here to explain axes 
```{r}
vare.cap <- capscale(dist_abund ~ 1, 
                     metadata)
```


```{r}
ss <- tibble(Axis.1 = scores(vare.cap)$sites[,1],
             Axis.2 = scores(vare.cap)$sites[,2],
             sample = metadata$samples,
             station = metadata$Station,
             fraction = metadata$fraction)
```




#Plot CCA ordination for adjusted samples by station and fraction
```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")

fig4d <- ggplot(ss, aes(x=Axis.1,y=Axis.2)) + 
  geom_point(aes(shape = station, colour = fraction, fill = fraction), alpha = 0.5, size = 3) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[2,1], yend=scores(ef, "vectors")[2,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[2,1], y=scores(ef, "vectors")[2,2]),
                label=names(ef$vectors$r)[2], nudge_x=0, nudge_y=0,size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[3,1], yend=scores(ef, "vectors")[3,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[3,1], y=scores(ef, "vectors")[3,2]),
                label=names(ef$vectors$r)[3], nudge_x=-0, nudge_y=-0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[7,1], yend=scores(ef, "vectors")[7,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[7,1], y=scores(ef, "vectors")[7,2]),
                label=names(ef$vectors$r)[7], nudge_y=0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[8,1], yend=scores(ef, "vectors")[8,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[8,1], y=scores(ef, "vectors")[8,2]),
                label=names(ef$vectors$r)[8], nudge_y=0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[13,1], yend=scores(ef, "vectors")[13,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[13,1], y=scores(ef, "vectors")[13,2]),
                label=names(ef$vectors$r)[13], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[16,1], yend=scores(ef, "vectors")[16,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[16,1], y=scores(ef, "vectors")[16,2]),
                label=names(ef$vectors$r)[16], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[17,1], yend=scores(ef, "vectors")[17,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[17,1], y=scores(ef, "vectors")[17,2]),
                label=names(ef$vectors$r)[17], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
  scale_colour_jcolors(palette = "default") +
  theme(panel.background = element_blank(),
        text = element_text(family = "merriweather"),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, size=1),
        axis.title=element_text(size=12),
        plot.title = element_text(size = 20, hjust = 0.5, colour = "black"),
        legend.key=element_blank(),
        legend.position="bottom",
        legend.direction="vertical",
        legend.background = element_blank(),
        legend.key.size = unit(.8, "line")) +
  guides(size="none") + xlab("Axis 1") + ylab("Axis 2") +
  ggtitle("Lake Erie Viral Community Capscale--CCA") +
  #scale_shape_manual(name="Distribution System",
  #                   values=c(21,10,25,3,4,8,22,23,24,9)) +
  #scale_color_manual(name="Residual Disinfectant?",
  #                   values = alpha(c(viridis(5)[1],
  #                                    viridis(5)[3]), 1),
  #                   labels = c("No", "Yes")) + 
  #scale_fill_manual(name="Residual Disinfectant?",
  #                   values = alpha(c(viridis(5)[1],
  #                                    viridis(5)[3]), 0.3),
  #                  labels = c("No", "Yes")) + 
  coord_equal()

fig4d
```

```{r}
ss <- tibble(Axis.1 = scores(vare.cap)$sites[,1],
             Axis.2 = scores(vare.cap)$sites[,2],
             sample = metadata$samples,
             date = metadata$Date,
             fraction = metadata$fraction)
```

#Plot CCA ordination for adjusted samples by date and fraction
```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")

fig4d <- ggplot(ss, aes(x=Axis.1,y=Axis.2)) + 
  geom_point(aes(shape = fraction, colour = date, fill = date), alpha = 1, size = 3) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[2,1], yend=scores(ef, "vectors")[2,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[2,1], y=scores(ef, "vectors")[2,2]),
                label=names(ef$vectors$r)[2], nudge_x=0, nudge_y=0,size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[3,1], yend=scores(ef, "vectors")[3,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[3,1], y=scores(ef, "vectors")[3,2]),
                label=names(ef$vectors$r)[3], nudge_x=-0, nudge_y=-0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[7,1], yend=scores(ef, "vectors")[7,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[7,1], y=scores(ef, "vectors")[7,2]),
                label=names(ef$vectors$r)[7], nudge_y=0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                   xend=scores(ef, "vectors")[8,1], yend=scores(ef, "vectors")[8,2],
                   ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[8,1], y=scores(ef, "vectors")[8,2]),
                label=names(ef$vectors$r)[8], nudge_y=0, size=5,
            check_overlap = T) +
  geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[13,1], yend=scores(ef, "vectors")[13,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[13,1], y=scores(ef, "vectors")[13,2]),
                label=names(ef$vectors$r)[13], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[16,1], yend=scores(ef, "vectors")[16,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[16,1], y=scores(ef, "vectors")[16,2]),
                label=names(ef$vectors$r)[16], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
    geom_segment(aes(x=0, y=0,
                 xend=scores(ef, "vectors")[17,1], yend=scores(ef, "vectors")[17,2],
                 ), colour="black", arrow=arrow(length = unit(0.05,"npc"))) +
  geom_text(aes(x=scores(ef, "vectors")[17,1], y=scores(ef, "vectors")[17,2]),
                label=names(ef$vectors$r)[17], nudge_y=0, nudge_x=0, size=5,
            check_overlap = T) +
  scale_color_jcolors(palette = "pal8") +
  scale_fill_jcolors(palette = "pal8") +
  theme(panel.background = element_blank(),
        text = element_text(family = "merriweather"),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, size=1),
        axis.title=element_text(size=12),
        plot.title = element_text(size = 20, hjust = 0.5, colour = "black"),
        legend.key=element_blank(),
        legend.position="bottom",
        legend.direction="vertical",
        legend.background = element_blank(),
        legend.key.size = unit(.8, "line")) +
  guides(size="none") + xlab("Axis 1") + ylab("Axis 2") +
  ggtitle("Lake Erie Viral Community Capscale--CCA") +
  scale_shape_manual(name="", values = c(21,22,23,24,25)) +
  
  coord_equal()

fig4d
```



```{r}
anova(vare.cap)
```


#Store CCA ordination as PNG
```{r}
png("taxonomy_nmds_capscale.png", width=9, height=6, units="in", res=300)
fig4d
dev.off()
```