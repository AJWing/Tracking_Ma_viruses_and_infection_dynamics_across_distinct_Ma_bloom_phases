---
title: "erie_ma_phage_coverage_analysis"
author: "A.J Wing"
date: '2022-09-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(data.table)
library(tidyr)
library(ggplot2)
library(tidyverse)
library(jcolors)
library(viridis)
library(cowplot)
library(gridExtra)

```

##generate my color palette first = green, second = blue, third = red, fourth = gold, fifth = purple
```{r}
station_12_colors <- c("#00A5CF", "#DE1A1A", "#574AE2", "#FFBF00")
sep_station_12_colors <- c("#29BF12", "#00A5CF", "#DE1A1A", "#574AE2", "#FFBF00")
station_2_colors <- c("#29BF12", "#00A5CF", "#DE1A1A", "#FFBF00")
station_4_colors <- c("#29BF12", "#00A5CF", "#DE1A1A", "#FFBF00")
aug_station_4_colors <- c("#29BF12", "#00A5CF", "#FFBF00")
```

##import metadata
```{r}
metadata <- read_tsv("~/Desktop/erie_story_r_work/2014_story_metadata_updated_12_15_21.tsv")
names(metadata)[names(metadata) == 'samples'] <- "sample"
metadata$sample <- gsub("Sample_","",metadata$sample)
```


```{r}
setwd("~/Desktop/erie_story_r_work/lmm01_no_lem01_all_vps_blast_results/")
```


```{r}
files = list.files(pattern="*best_hit_combined_phage_hits.txt",recursive=TRUE)

blast_hits <- function(x) {
  # Check if file is empty
  if (file.info(x)$size == 0) {
    message(paste0("Skipping empty file ", x))
    return(NULL)
  } else {
    tmp <- read.delim(x, header = FALSE, sep = "\t")
    tmp$sample <- gsub("", "", gsub("_best_hit_combined_phage_hits.txt", "", basename(x)))
    return(tmp)
  }
}

tables <- Filter(NROW, lapply(files, blast_hits))
combined_blast_data <- rbindlist(tables)
```


##modify giant blast file to contain meaningful columns
```{r}

names(combined_blast_data)[names(combined_blast_data) == 'V2'] <- "ref_genome"
names(combined_blast_data)[names(combined_blast_data) == 'V3'] <- "percent_identity"
names(combined_blast_data)[names(combined_blast_data) == 'V4'] <- "query_seq_length"
names(combined_blast_data)[names(combined_blast_data) == 'V5'] <- "ref_seq_length"
names(combined_blast_data)[names(combined_blast_data) == 'V6'] <- "hit_length"
names(combined_blast_data)[names(combined_blast_data) == 'V7'] <- "mismatches"
names(combined_blast_data)[names(combined_blast_data) == 'V8'] <- "gap_open"
names(combined_blast_data)[names(combined_blast_data) == 'V9'] <- "query_start"
names(combined_blast_data)[names(combined_blast_data) == 'V10'] <- "query_end"
names(combined_blast_data)[names(combined_blast_data) == 'V11'] <- "ref_start"
names(combined_blast_data)[names(combined_blast_data) == 'V12'] <- "ref_end"
names(combined_blast_data)[names(combined_blast_data) == 'V13'] <- "e_value"
names(combined_blast_data)[names(combined_blast_data) == 'V14'] <- "bit_score"



```


##combine blast with metadata

```{r}
combined_blast_data <- left_join(combined_blast_data,metadata,by="sample")
dim(combined_blast_data)
```

##look at only blast samples of interest

```{r}
combined_blast_data_virome <- combined_blast_data[combined_blast_data$Date=="4-Aug-14",]

combined_blast_data_virome <- combined_blast_data_virome[combined_blast_data_virome$Station=="WLE12"]

combined_blast_data_virome <- combined_blast_data_virome[combined_blast_data_virome$fraction %in% c("Viral", "Whole", "3", "53"),]
```


```{r}
names(combined_blast_data_virome)[names(combined_blast_data_virome) == 'ref_genome'] <- "Genome"
names(combined_blast_data_virome)[names(combined_blast_data_virome) == 'ref_start'] <- "Start"
names(combined_blast_data_virome)[names(combined_blast_data_virome) == 'ref_end'] <- "Stop"
names(combined_blast_data_virome)[names(combined_blast_data_virome) == 'percent_identity'] <- "Id"
names(combined_blast_data_virome)[names(combined_blast_data_virome) == 'sample'] <- "Sample"
```



##showing different coverage between samples with adjusted y-axis

```{r}
# Plot histograms separately for each sample adjusting the y axis
hist_3 <- ggplot(data = combined_blast_data_virome, aes(y = Id, fill = fraction)) +
  geom_histogram(binwidth = 1) +
  scale_fill_manual(values = station_12_colors) +
  facet_wrap(fraction~., ncol = 4, scales = "free_x") +
  xlab("Read Count") +
  ylab("Percent Identity") +
  guides(colour = guide_legend(override.aes = list(size=10))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(panel.background = element_blank(),
        axis.line = element_line(colour = "black"), 
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 12),
        strip.background = element_rect(colour= "black", fill = "lemon chiffon", linetype= "solid"),
        axis.title=element_text(size=12),
        legend.box.background = element_rect(size = 1,colour = "black"),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 12, hjust = 0.5, colour = "black"),
        axis.text.y = element_text(size=14, colour = "black"),
        axis.text.x  = element_text(size=10, colour="black"),
        plot.margin = unit(c(1, 1, 1, 1),"lines"))
        plot.margin = margin(t = 1,  # Top margin
                             r = 1,  # Right margin
                             b = 3,  # Bottom margin
                             l = 2,  # Left margin
                             unit = "cm")
  
hist_3

```


```{r}
histo <- ggplot(data = combined_blast_data_virome, aes(y = Id, fill = fraction)) +
  geom_histogram(binwidth = 1, alpha = 0.6) +  # Histogram with transparency
  geom_freqpoly(binwidth = 0.8, size = 1, color = "darkgreen") +  # Smoothed line following histogram shape
  scale_fill_manual(values = station_12_colors) +
  facet_wrap(fraction ~ ., ncol = 4, scales = "free_x") +
  xlab("Read Count") +
  ylab("Count") +  # Change y-axis label to "Count"
  guides(colour = guide_legend(override.aes = list(size = 10))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(panel.background = element_blank(),
        axis.line = element_line(colour = "black"), 
        panel.border = element_rect(colour = "black", fill = NA, size = 1),
        strip.text = element_text(size = 12),
        strip.background = element_rect(colour = "black", fill = "lemon chiffon", linetype = "solid"),
        axis.title = element_text(size = 12),
        legend.box.background = element_rect(size = 1, colour = "black"),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 12, hjust = 0.5, colour = "black"),
        axis.text.y = element_text(size = 14, colour = "black"),
        axis.text.x = element_text(size = 10, colour = "black"),
        plot.margin = unit(c(1, 1, 1, 1), "lines")) +
  coord_cartesian(clip = "off")  # To prevent elements from being clipped

histo

```


```{r}
png("~/Desktop/erie_story_r_work/lmm01_aug4_wle12_histo_with_line_5_24_23.png", width=1000, height=600)
histo
dev.off()
```

```{r}
pdf("~/Desktop/erie_story_r_work/lmm01_aug4_wle12_histo_with_line_5_24_23.pdf", width=9, height=6)
histo
dev.off()
```

##show all histograms in same plot

```{r}
hist_3 <- ggplot(data = combined_blast_data_virome, aes(y = Id, fill = fraction)) +
  geom_histogram(binwidth = 1) +
  scale_fill_manual(values = station_12_colors) +
  xlab("Read Count") +
  ylab("Percent Identity") +
  guides(colour = guide_legend(override.aes = list(size=10))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(panel.background = element_blank(),
        axis.line = element_line(colour = "black"), 
        panel.border = element_rect(colour = "black", fill = NA, size = 1),
        strip.text = element_text(size = 12),
        strip.background = element_rect(colour = "black", fill = "lemon chiffon", linetype = "solid"),
        axis.title = element_text(size = 12),
        legend.box.background = element_rect(size = 1, colour = "black"),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 12, hjust = 0.5, colour = "black"),
        axis.text.y = element_text(size = 14, colour = "black"),
        axis.text.x = element_text(size = 10, colour = "black"),
        plot.margin = margin(t = 1, r = 1, b = 3, l = 2, unit = "cm"))
        
hist_3


```

```{r}
combined_blast_data_virome$fraction <- factor(combined_blast_data_virome$fraction,
                                             levels = c("Whole", "3", "Viral", "53"))

shared_histo <- ggplot(data = combined_blast_data_virome, aes(y = Id, fill = fraction)) +
  geom_histogram(binwidth = 1) +
  scale_fill_manual(values = c("Whole" = "#FFBF00", "3" = "#00A5CF", "Viral" = "#574AE2", "53" = "#DE1A1A")) +
  xlab("Read Count") +
  ylab("Percent Identity") +
  guides(colour = guide_legend(override.aes = list(size = 10))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(panel.background = element_blank(),
        axis.line = element_line(colour = "black"), 
        panel.border = element_rect(colour = "black", fill = NA, size = 1),
        strip.text = element_text(size = 12),
        strip.background = element_rect(colour = "black", fill = "lemon chiffon", linetype = "solid"),
        axis.title = element_text(size = 12),
        legend.box.background = element_rect(size = 1, colour = "black"),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 12, hjust = 0.5, colour = "black"),
        axis.text.y = element_text(size = 14, colour = "black"),
        axis.text.x = element_text(size = 10, colour = "black"),
        plot.margin = margin(t = 1, r = 1, b = 3, l = 2, unit = "cm")) +
  scale_x_continuous(limits = c(0, 200000))

shared_histo


```


```{r}
pdf("~/Desktop/erie_story_r_work/shared_histo_aug_lmm01_5_18_23.pdf", width=6, height=9)
shared_histo
dev.off()
```

##if wanted to try not stacked and instead with alpha
```{r}
hist_3 <- ggplot(data = combined_blast_data_virome, aes(y = Id, fill = fraction)) +
  geom_histogram(binwidth = 1, position = "identity", alpha = 0.5) +
  scale_fill_manual(values = station_12_colors) +
  xlab("Read Count") +
  ylab("Percent Identity") +
  guides(colour = guide_legend(override.aes = list(size = 10))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(panel.background = element_blank(),
        axis.line = element_line(colour = "black"), 
        panel.border = element_rect(colour = "black", fill = NA, size = 1),
        strip.text = element_text(size = 12),
        strip.background = element_rect(colour = "black", fill = "lemon chiffon", linetype = "solid"),
        axis.title = element_text(size = 12),
        legend.box.background = element_rect(size = 1, colour = "black"),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 12, hjust = 0.5, colour = "black"),
        axis.text.y = element_text(size = 14, colour = "black"),
        axis.text.x = element_text(size = 10, colour = "black"),
        plot.margin = margin(t = 1, r = 1, b = 3, l = 2, unit = "cm"))

hist_3

```

##try recruitment plot
```{r}
# Start with the actual recruitment plot

plot_1 <- ggplot(data = combined_blast_data_virome, aes(xmin = Start, xmax = Stop, ymin = Id, ymax = Id, color = fraction)) + 
  scale_y_continuous(limits = c(75, 101), breaks = c(0, 20, 40, 60, 80, 100)) + 
  ylab("Percent Identity") + 
  xlab("Genomic position (bp)") +
  ggtitle("4 Aug WLE12 LMM01 Only") +
  scale_color_manual(values = station_12_colors) + 
  geom_rect(size = 2, alpha = 0.8, fill = "white") + 
  guides(col = guide_legend(override.aes = list(alpha = 0.5, size = 10))) + 
  theme(panel.background = element_blank(),
    axis.line = element_line(colour = "black"), 
    panel.border = element_rect(colour = "black", fill=NA, size=1),
    plot.title = element_text(size = 12, lineheight = 0.8, hjust = 0.0), 
    axis.title = element_text(size = 12, lineheight = 0.8),
    legend.position = 'left',
    legend.justification = 'center', 
    legend.text = element_text(size = 9), legend.key.size = unit(0.8, "line"),
    axis.text = element_text(color = "black", size = 10),
    axis.ticks = element_line(color = "black")
  )   
   
  
plot_1
```




##match Berry recruitment dataframe column format

```{r}
combined_blast_data_virome_slim <-select(combined_blast_data_virome, c('Genome', 'Start', 'Stop', 'Id', 'Sample', 'fraction'))
```

##matche Berry column names

```{r}
names(combined_blast_data_virome_slim)[names(combined_blast_data_virome_slim) == 'ref_genome'] <- "Genome"
names(combined_blast_data_virome_slim)[names(combined_blast_data_virome_slim) == 'ref_start'] <- "Start"
names(combined_blast_data_virome_slim)[names(combined_blast_data_virome_slim) == 'ref_end'] <- "Stop"
names(combined_blast_data_virome_slim)[names(combined_blast_data_virome_slim) == 'percent_identity'] <- "Id"
names(combined_blast_data_virome_slim)[names(combined_blast_data_virome_slim) == 'sample'] <- "Sample"
```

```{r}
combined_blast_data_virome_slim$fraction <- factor(combined_blast_data_virome_slim$fraction, labels = c("3um", "53um", "Viral", "Whole"))
```

Then we generate recruitment plots for each sample 
```{r}

# Max length of genome
max_length_start <- max(combined_blast_data_virome_slim$Start)
max_length_stop <- max(combined_blast_data_virome_slim$Stop)
max_length <- max(max_length_start,max_length_stop)

# Final matrix to store coverage
coverage <- matrix(data = NA, nrow = 0, ncol = 3)

# Change this value to modify the size of the sliding window, 
# larger sliding window (e.g. max_length/20) will be more smoothed, 
# smaller window (e.g. max_length/100) will be more detailed
window_size_half <- max_length/50  

# Can lower this value (e.g. max_length/100) if the coverage computation is too long
step <- max_length/500 
```

Max length is `r max_length`.     
Window size half is `r window_size_half`.    
Step is `r step`.     

```{r}
# Calculate coverage for each sample
for (samp in levels(combined_blast_data_virome_slim$fraction)) {
  
  # Filter dataframe to one sample
  recruit_sample <- filter(combined_blast_data_virome_slim, fraction == samp)
  
  # Generate a matrix to hold coverage for each sample 
  coverage_sample <- matrix(0, max_length, 1)
  for (i in 1:nrow(recruit_sample)) {
    for (j in recruit_sample[i,2][[1]]:recruit_sample[i,3][[1]]) {
      coverage_sample[j,1] <- coverage_sample[j,1] + 1
    }
  }
  
  i = 1
  while (i < max_length) {
    total <- 2 * window_size_half 
    boundary_start <- i - window_size_half
    if (boundary_start < 0) {
      total <- total + boundary_start
      boundary_start <- 0
    }
    boundary_stop <- i + window_size_half
    if (boundary_stop > max_length) {
      total <- total - (boundary_stop - max_length)
      boundary_stop <- max_length
    }
    cover <- sum(coverage_sample[boundary_start:boundary_stop, 1])/total
    new_vec <- c(i, cover, samp)
    coverage <- rbind(coverage, new_vec)
    i <- i + step
  }
  
}

# Format coverage data.frame
coverage <- data.frame(coverage, row.names = NULL)
colnames(coverage) <- c("Coord", "Coverage", "fraction")
coverage$Coord <- as.numeric(as.character(coverage$Coord))
coverage$Coverage <- as.numeric(as.character(coverage$Coverage))
coverage$Sample <- factor(coverage$fraction, levels = c("3um", "53um", "Viral", "Whole"))

```

```{r fig.height=4, fig.width=9}
# Then the bottom coverage plot
ratio.display <- 50
ratio.values <- (max(coverage$Coord) - min(coverage$Coord))/(max(coverage$Coverage) -
  min(coverage$Coverage))

 recruitment_coverage_plot <- ggplot(data = coverage, aes(x = Coord, y = Coverage, group = fraction, color = fraction, name = fraction))  + 
  scale_x_continuous(limits = c(0, max_length)) + 
  scale_y_log10() +
  scale_color_manual(values = station_12_colors) +
  ylab("Log10(coverage)") +  
  xlab("Genomic position (bp)") +
  geom_line(size = 0.8) + 
  guides(
    col = guide_legend(override.aes = list(size = 3))
  ) + 
  theme(panel.background = element_blank(),
    axis.line = element_line(colour = "black"), 
    panel.border = element_rect(colour = "black", fill=NA, size=1),
    text = element_text(size = 8, lineheight = 0.8),  
    legend.position = 'none', 
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    legend.justification = 'center',
    axis.text = element_text(color = "black", size = 10),
    axis.title = element_text(size = 12),
    axis.ticks = element_line(color = "black")
  )  
  #scale_color_manual(values = sample_colors) 

recruitment_coverage_plot
```

Then we put all of these together as nicely as we can
```{r fig.width=10, fig.height=6}

# Extract legend
grab_legend <- function(a_ggplot) {
    tmp <- ggplot_gtable(ggplot_build(a_ggplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    legend
}

legend <- grab_legend(hist_3)

  
gp <- ggplotGrob(plot_1 + theme(legend.position = "none"))
gp2 <- ggplotGrob(hist_3 + theme(legend.position = "none"))
gp3 <- ggplotGrob(recruitment_coverage_plot)
maxWidth = grid::unit.pmax(gp$widths[2:5], gp2$widths[2:5])
gp$widths[2:5] <- as.list(maxWidth)
gp2$widths[2:5] <- as.list(maxWidth)
gp_arrange <- arrangeGrob(gp, gp2, gp3, legend, nrow = 2, ncol = 3, widths = c(8,8,8))

combined_plot <- ggdraw() +
  draw_plot(gp_arrange, x = 0, y = 0, width = 1, height = 1)

combined_plot
```


```{r}
png("~/Desktop/erie_story_r_work/lmm01_only_sep29_wle12_pt_&_cvr_4_7_23.png", width=1000, height=600)
combined_plot
dev.off()
```

```{r}
pdf("~/Desktop/erie_story_r_work/lmm01_only_sep29_wle12_pt_&_cvr_4_7_23.pdf", width=9, height=6)
combined_plot
dev.off()
```


```{r}
# make a copy of the coverage df to modify it

modified_coverage <- data.frame(coverage)
```

```{r}
# rename the 'Coord' column to 'Start'
colnames(modified_coverage)[which(names(modified_coverage) == "Coord")] <- "Start"

# create a new 'Stop' column
modified_coverage$Stop <- c(modified_coverage$Start[-1] - 0.001, NA)
modified_coverage$Stop[which(is.na(modified_coverage$Stop))] <- modified_coverage$Start[length(modified_coverage$Start)] + 0.001

modified_coverage <-select(modified_coverage, c('Start', 'Stop', 'Coverage', 'fraction'))

```


##write coverage file to tsv
```{r}
write_tsv(modified_coverage, "~/Desktop/erie_story_r_work/lmm01_aug_wle12_coverage_data.tsv", col_names = TRUE)
```

